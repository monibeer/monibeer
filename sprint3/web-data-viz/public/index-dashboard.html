<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Home</title>
    <link rel="stylesheet" href="./css/assets/main.css">
    <link rel="stylesheet" href="./css/assetsDashboard/main.css">
    <link rel="stylesheet" href="./css/indexDashboard.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>

</head>

<body onload="pegarDadosDashHome(), atualizarKPIs(), pegarHistoricoAlerta()">
    <section class="dashboard">
        <div class="sidebar">
            <a href="./index-dashboard.html">
                <div class="logotipo">
                    <img src="./assets/monibeer-logo.png" alt="">
                </div>
            </a>

            <!-- <div class="profile">
            <div class="circle-profile">
                <img src="./assets/image.png" alt="" class="profile-img">
            </div>
            <h3>Rodrigo Souza</h3>
            <p>Administrador</p>
        </div> -->

            <div class="buttons-navegation">
                <div class="container-item">
                    <a href="./index-dashboard.html">
                        <div class="navigation-item active">
                            <i class="fa-solid fa-house"></i>
                            <p>Home</p>
                        </div>
                    </a>

                    <a href="./dashboard.html">
                        <div class="navigation-item">
                            <i class="fa-solid fa-chart-column"></i>
                            <p>Dashboard</p>
                        </div>
                    </a>

                    <!-- <div class="navigation-item">
                    <i class="fa-solid fa-gear"></i>
                    <p>Configurações</p>
                </div> -->
                </div>

                <a href="./login.html">
                    <div class="logout-item navigation-item">
                        <i class="fa-solid fa-right-from-bracket"></i>
                        <p>Logout</p>
                    </div>
                </a>
            </div>
        </div>

        <div class="container-dashboard">
            <div class="header">
                <div class="container-searchBarGroup">
                    <i class="fa-solid fa-bars"></i>

                    <h3>Home</h3>
                    <!-- <div class="container-search">
                    <i class="fa-solid fa-magnifying-glass"></i>
                    <input type="text" placeholder="Search..">
                </div> -->
                </div>


                <div class="container-actions">
                    <!-- <div class="container-theme-dark-light">
                    <img src="https://static-00.iconduck.com/assets.00/sun-symbol-emoji-512x512-qjm8vnpc.png" alt="">
                </div> -->
                    <i class="fa-solid fa-bell"></i>
                    <span>|</span>
                    <div class="container-mini-profile">
                        <img src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png" alt="">
                        <p>Rodrigo Silva</p>
                    </div>
                </div>
            </div>

            <p class="datatime-update" id="ultimaAtualizacao">Última Atualização - 25/04/2025 às 10:40</p>

            <div class="container-info-fermenter">
                <div class="info">
                    <h2 class="title-info">Visão Geral do Desempenho</h2>

                    <div class="dashboard-kpis">
                        <div class="container-total">
                            <div class="kpi total">
                                <p class="kpi-label">Total de Fermentadoras</p>
                                <p class="kpi-value" id="totalGeral">0</p>
                            </div>
                        </div>

                        <div class="alerts-grid">
                            <div class="kpi ipa">
                                <div class="kpi-value" id="foraIdealIpa">0</div>
                                <div class="kpi-left">
                                    <div class="kpi-info">
                                        <p class="kpi-context">Fora do ideal</p>
                                        <p class="kpi-label">IPA</p>
                                        <p class="kpi-desc">fermentadoras fora do ideal</p>
                                    </div>
                                </div>
                            </div>

                            <div class="kpi pilsen">
                                <div class="kpi-value" id="foraIdealPilsen">0</div>
                                <div class="kpi-left">
                                    <div class="kpi-info">
                                        <p class="kpi-context">Fora do ideal</p>
                                        <p class="kpi-label">Pilsen</p>
                                        <p class="kpi-desc">fermentadoras fora do ideal</p>
                                    </div>
                                </div>
                            </div>

                            <div class="kpi ipa alert">
                                <div class="kpi-value" id="alertaCriticoIpa">0</div>
                                <div class="kpi-left">
                                    <div class="kpi-info">
                                        <p class="kpi-context">Alerta Crítico</p>
                                        <p class="kpi-label">IPA</p>
                                        <p class="kpi-desc">fermentadoras em estado crítico</p>
                                    </div>
                                </div>
                            </div>

                            <div class="kpi pilsen alert">
                                <div class="kpi-value" id="alertaCriticoPilsen">0</div>
                                <div class="kpi-left">
                                    <div class="kpi-info">
                                        <p class="kpi-context">Alerta Crítico</p>
                                        <p class="kpi-label">Pilsen</p>
                                        <p class="kpi-desc">fermentadoras em estado crítico</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>



                    <div class="container-graphic">
                        <div class="graphics">
                            <div class="info-graphic status">
                                <h3>Status Fermentadoras</h3>
                            </div>
                            <canvas id="graphic-statusFermenter" style="width: 90%; height: 100%;"></canvas>
                        </div>


                        <div class="container-notification-history">
                            <div class="info-history">
                                <h4>Histórico</h4>
                                <p>Acessar Mais ></p>
                            </div>
                            <div class="container-history" id="containerHistoricoAlertas">
                            </div>
                        </div>

                    </div>
                </div>
            </div>
    </section>
</body>

</html>
<script src="./js/chartJs-Home.js"></script>
<script>
    const dataAtual = new Date();
    const dia = String(dataAtual.getDate()).padStart(2, '0');
    const mes = String(dataAtual.getMonth() + 1).padStart(2, '0');
    const ano = dataAtual.getFullYear();
    const dataAtualPC = `${ano}-${mes}-${dia}`;

    function pegarDadosDashHome() {
        const session = sessionStorage.FERMENTADORAS;
        const idEmpresa = JSON.parse(session)[0].fkEmpresa;

        fetch('/dashboard/pegarDashboardHome', {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                idEmpresaServer: idEmpresa,
                dataAtualServer: dataAtualPC
            }),
        }).then(function (response) {
            if (response.ok) {
                response.json().then(function (resposta) {
                    sessionStorage.setItem('DASHBOARDHOME', JSON.stringify(resposta.dadosDashHome));
                    atualizarKPIs()
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });

        atualizarDataHoraAtualizacao();

    }

    function pegarHistoricoAlerta() {
        const session = sessionStorage.FERMENTADORAS;
        const idEmpresa = JSON.parse(session)[0].fkEmpresa;

        fetch('/dashboard/pegarHistoricoAlerta', {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                idEmpresaServer: idEmpresa,
            }),
        }).then(function (response) {
            if (response.ok) {
                response.json().then(function (resposta) {
                    sessionStorage.setItem('HISTORICO_ALERTA', JSON.stringify(resposta.historicoAlerta));
                    atualizarHistoricoAlerta();
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });
    }


    function atualizarKPIs() {
        let totalGeral = 0;

        JSON.parse(sessionStorage.DASHBOARDHOME).forEach((estilo) => {
            let tipo = estilo.estiloCerveja.toLowerCase();

            let foraIdeal = estilo.fermentadoras_fora_do_ideal;
            let alertaCritico = estilo.fermentadoras_em_critico;

            if (tipo == "ipa") {
                document.getElementById("foraIdealIpa").innerText = foraIdeal;
                document.getElementById("alertaCriticoIpa").innerText = alertaCritico;
            } else if (tipo == "pilsen") {
                document.getElementById("foraIdealPilsen").innerText = foraIdeal;
                document.getElementById("alertaCriticoPilsen").innerText = alertaCritico;
            }

            totalGeral += estilo.total_ferm;
        });

        document.getElementById("totalGeral").innerText = totalGeral;
    }

    function atualizarDataHoraAtualizacao() {
        const agora = new Date();
        const dia = String(agora.getDate()).padStart(2, '0');
        const mes = String(agora.getMonth() + 1).padStart(2, '0');
        const ano = agora.getFullYear();
        const horas = String(agora.getHours()).padStart(2, '0');
        const minutos = String(agora.getMinutes()).padStart(2, '0');

        const texto = `Última Atualização - ${dia}/${mes}/${ano} às ${horas}:${minutos}`;
        document.getElementById("ultimaAtualizacao").innerText = texto;
    }

    function atualizarHistoricoAlerta() {
        var historico = JSON.parse(sessionStorage.getItem('HISTORICO_ALERTA'));
        var container = document.getElementById("containerHistoricoAlertas");

        container.innerHTML = "";

        historico.forEach(function (alerta) {
            var tipo_alerta = alerta.nivel_alerta;
            console.log(tipo_alerta)
            var mensagem = alerta.mensagem;
            var horario = alerta.horario_alerta;

            var icone = "";
            if (tipo_alerta === "Crítico") {
                icone = "./assets/alert-critico.png";
            } else if (tipo_alerta === "Atenção") {
                icone = "https://cdn-icons-png.flaticon.com/512/257/257195.png";
            } else {
                icone = "https://img.freepik.com/vetores-premium/icone-de-avisos-de-notificacao_1076610-18996.jpg?semt=ais_hybrid&w=740";
            }

            var alertaHTML =
                '<div class="history">' +
                '<img src="' + icone + '" alt="">' +
                '<div class="data-history">' +
                '<h4>' + tipo_alerta + '</h4>' +
                '<p>' + mensagem + '</p>' +
                '</div>' +
                '<p class="datatime-history">' + horario + '</p>' +
                '</div>';

            container.innerHTML += alertaHTML;
        });
    }


    setInterval(() => {
        pegarDadosDashHome();
        pegarHistoricoAlerta();
        atualizarKPIs();
        atualizarHistoricoAlerta();
        gerarDadosGrafico();
    }, 60000);


</script>