<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard - Home</title>

    <link rel="stylesheet" href="./css/assets/main.css" />
    <link rel="stylesheet" href="./css/assetsDashboard/main.css" />
    <link rel="stylesheet" href="./css/dashboard.css" />

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
</head>

<body onload="iniciarVerificacaoApos1Min30()">
    <section class="dashboard">
        <div class="sidebar">
            <a href="./index-dashboard.html">
                <div class="logotipo">
                    <img src="./assets/monibeer-logo.png" alt="Logo Monibeer" />
                </div>
            </a>

            <div class="buttons-navegation">
                <div class="container-item">
                    <a href="./index-dashboard.html">
                        <div class="navigation-item">
                            <i class="fa-solid fa-house"></i>
                            <p>Home</p>
                        </div>
                    </a>
                    <a href="./setores.html">
                        <div class="navigation-item active">
                            <i class="fa-solid fa-chart-column"></i>
                            <p>Dashboard</p>
                        </div>
                    </a>
                </div>

                <a href="./login.html">
                    <div class="logout-item navigation-item">
                        <i class="fa-solid fa-right-from-bracket"></i>
                        <p>Logout</p>
                    </div>
                </a>
            </div>
        </div>

        <div class="container-dashboard">
            <div class="header">
                <div class="container-searchBarGroup">
                    <i class="fa-solid fa-bars"></i>
                    <h3>Dashboard</h3>
                </div>
                <div class="container-actions">
                    <i class="fa-solid fa-bell"></i>
                    <span>|</span>
                    <div class="container-mini-profile">
                        <img src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png" alt="Avatar" />
                        <p>Rodrigo Silva</p>
                    </div>
                </div>
            </div>

            <div class="container-data-filters">
                <p class="datatime-update">Última Atualização - <span id="dataAtualizacao"></span></p>
            </div>

            <div class="container-info-fermenter">
                <canvas id="myChartCanvas"></canvas>
                <div id="avisoCaptura1" style="margin-top: 10px; color: red;"></div>
            </div>
        </div>
    </section>

    <script>

        let proximaAtualizacao;

        function obterDadosGrafico(id) {
            fetch(`/medidas/ultimas/${id}`, { cache: 'no-store' }).then(response => {
                if (response.ok) {
                    response.json().then(resposta => {
                        resposta.reverse();
                        plotarGrafico(resposta, id);
                    });
                } else {
                    console.error('Nenhum dado encontrado');
                }
            }).catch(error => {
                console.error('Erro na API:', error);
            });
        }

        function plotarGrafico(resposta, id) {
            let labels = [];

            let dados = {
                labels: labels,
                datasets: [
                    {
                        label: 'Temperatura',
                        data: [],
                        fill: false,
                        borderColor: 'rgb(255, 165, 0)',
                        tension: 0.1
                    },
                    {
                        label: 'Temperatura Máx.',
                        data: new Array(resposta.length).fill(22),
                        fill: false,
                        borderColor: 'red',
                        tension: 0.1
                    },
                    {
                        label: 'Temperatura Mín.',
                        data: new Array(resposta.length).fill(18),
                        fill: false,
                        borderColor: 'blue',
                        tension: 0.1
                    }
                ],
            };

            resposta.forEach(reg => {
                labels.push(reg.momento_grafico);
                dados.datasets[0].data.push(reg.temperatura);
            });

            const config = {
                type: 'line',
                data: dados,
                options: {
                    scales: {
                        y: {
                            min: 13,
                            max: 29,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }

            };

            let myChart = new Chart(
                document.getElementById(`myChartCanvas`),
                config
            );

            proximaAtualizacao = setTimeout(() => atualizarGrafico(id, dados, myChart), 5000);
        }

        function atualizarGrafico(id, dados, myChart) {
            fetch(`/medidas/tempo-real/${id}`, { cache: 'no-store' }).then(response => {
                if (response.ok) {
                    response.json().then(novoRegistro => {
                        const aviso = document.getElementById(`avisoCaptura${id}`);
                        aviso.innerHTML = "";

                        const novo = novoRegistro[0];
                        if (novo.momento_grafico === dados.labels[dados.labels.length - 1]) {
                            aviso.innerHTML = `<i class="fa-solid fa-triangle-exclamation"></i> Sem dados novos.`;
                        } else {
                            dados.labels.shift();
                            dados.labels.push(novo.momento_grafico);

                            dados.datasets[0].data.shift();
                            dados.datasets[0].data.push(novo.temperatura);

                            dados.datasets[1].data.shift();
                            dados.datasets[1].data.push(22);

                            dados.datasets[2].data.shift();
                            dados.datasets[2].data.push(18);

                            myChart.update();
                        }

                        proximaAtualizacao = setTimeout(() => atualizarGrafico(id, dados, myChart), 5000);
                    });
                }
            }).catch(error => {
                console.error("Erro na atualização:", error);
            });
        }

        document.getElementById("dataAtualizacao").innerText = new Date().toLocaleString();


        window.onload = () => {
            obterDadosGrafico(1);
        };


        function iniciarVerificacaoApos1Min30() {
            const chave = "tempoEntrada";
            const agora = Date.now();

            if (!localStorage.getItem(chave)) {
                localStorage.setItem(chave, agora);
            }

            const tempoSalvo = parseInt(localStorage.getItem(chave), 10);
            const tempoDecorrido = agora - tempoSalvo;
            const umMinMeio = 1.5 * 60 * 1000;
            console.log("Tempo necessário:", umMinMeio, "ms");

            if (tempoDecorrido >= umMinMeio) {
                console.log('oier if');
                buscarDadosEVerificar();
                iniciarRepeticao(); // inicia loop após a 1ª execução
            } else {
                console.log('oier else');
                const restante = umMinMeio - tempoDecorrido;
                setTimeout(function () {
                    buscarDadosEVerificar();
                    iniciarRepeticao(); // inicia loop após o delay
                }, restante);
            }
        }

        function iniciarRepeticao() {
            setInterval(buscarDadosEVerificar, 1.5 * 60 * 1000);
        }

        function buscarDadosEVerificar() {
            console.log('Buscando dados e verificando...');
            const session = sessionStorage.FERMENTADORAS;
            const idEmpresa = JSON.parse(session)[0].fkEmpresa;

            fetch(`/medidas/validacaoTemp/${idEmpresa}`, { cache: 'no-store' }).then(response => {
                if (response.ok) {
                    response.json().then(resposta => {
                        verificarAlerta(resposta);
                    });
                } else {
                    console.error('Nenhum dado encontrado');
                }
            }).catch(error => {
                console.error('Erro na API:', error);
            });
        }

        function verificarAlerta(dados) {
            var sensores = {};

            for (var i = 0; i < dados.length; i++) {
                var dado = dados[i];
                var sensorId = dado.fkSensor;

                if (!sensores[sensorId]) {
                    sensores[sensorId] = [];
                }
                sensores[sensorId].push(dado);
            }

            var listaSensores = Object.keys(sensores);

            for (var i = 0; i < listaSensores.length; i++) {
                var sensorId = listaSensores[i];
                var registros = sensores[sensorId];
                var total = registros.length;
                var fora = 0;

                for (var j = 0; j < registros.length; j++) {
                    var r = registros[j];
                    if (r.temperatura < r.limiteTempMin || r.temperatura > r.limiteTempMax) {
                        fora++;
                    }
                }

                var percentual = (fora / total) * 100;

                if (percentual >= 40) {
                    alert("⚠️ Sensor " + sensorId + ": " + percentual.toFixed(1) + "% fora do ideal!");
                } else {
                    console.log("Sensor " + sensorId + ": tudo certo (" + percentual.toFixed(1) + "% fora).");
                }
            }
        }

        // Iniciar tudo
        iniciarVerificacaoApos1Min30();

    </script>
</body>

</html>