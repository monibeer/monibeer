<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard - Home</title>

    <link rel="stylesheet" href="./css/assets/main.css" />
    <link rel="stylesheet" href="./css/assetsDashboard/main.css" />
    <link rel="stylesheet" href="./css/dashboard.css" />

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
</head>

<body onload="iniciarVerificacaoApos1Min30()">
    <section class="dashboard">
        <div class="sidebar">
            <a href="./index-dashboard.html">
                <div class="logotipo">
                    <img src="./assets/monibeer-logo.png" alt="Logo Monibeer" />
                </div>
            </a>

            <div class="buttons-navegation">
                <div class="container-item">
                    <a href="./index-dashboard.html">
                        <div class="navigation-item">
                            <i class="fa-solid fa-house"></i>
                            <p>Home</p>
                        </div>
                    </a>
                    <a href="./setores.html">
                        <div class="navigation-item">
                            <i class="fa-solid fa-building"></i>
                            <p>Meus Setores</p>
                        </div>
                    </a>
                </div>

                <a href="./login.html">
                    <div class="logout-item navigation-item">
                        <i class="fa-solid fa-right-from-bracket"></i>
                        <p>Logout</p>
                    </div>
                </a>
            </div>
        </div>

        <div class="container-dashboard">
            <div class="header">
                <div class="container-searchBarGroup">
                    <i class="fa-solid fa-bars"></i>
                    <h3>Dashboard</h3>
                </div>
                <div class="container-actions">
                    <i class="fa-solid fa-bell"></i>
                    <span>|</span>
                    <div class="container-mini-profile">
                        <img src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png" alt="Avatar" />
                        <p>Rodrigo Silva</p>
                    </div>
                </div>
            </div>

            <div class="container-data-filters">
                <p class="datatime-update">Última Atualização - <span id="dataAtualizacao"></span></p>
            </div>

            <div class="container-info-fermenter">
                <canvas id="myChartCanvas"></canvas>
                <div id="avisoCaptura1" style="margin-top: 10px; color: red;"></div>
            </div>
        </div>
    </section>

    <script>

        let proximaAtualizacao;

        function obterDadosGrafico(id) {
            fetch(`/medidas/ultimas/${id}`, { cache: 'no-store' }).then(response => {
                if (response.ok) {
                    response.json().then(resposta => {
                        resposta.reverse();
                        plotarGrafico(resposta, id);
                    });
                } else {
                    console.error('Nenhum dado encontrado');
                }
            }).catch(error => {
                console.error('Erro na API:', error);
            });
        }

        function plotarGrafico(resposta, id) {
            let labels = [];

            let dados = {
                labels: labels,
                datasets: [
                    {
                        label: 'Temperatura',
                        data: [],
                        fill: false,
                        borderColor: 'rgb(255, 165, 0)',
                        tension: 0.1
                    },
                    {
                        label: 'Temperatura Máx.',
                        data: new Array(resposta.length).fill(22),
                        fill: false,
                        borderColor: 'red',
                        tension: 0.1
                    },
                    {
                        label: 'Temperatura Mín.',
                        data: new Array(resposta.length).fill(18),
                        fill: false,
                        borderColor: 'blue',
                        tension: 0.1
                    }
                ],
            };

            resposta.forEach(reg => {
                labels.push(reg.momento_grafico);
                dados.datasets[0].data.push(reg.temperatura);
            });

            const config = {
                type: 'line',
                data: dados,
                options: {
                    scales: {
                        y: {
                            min: 13,
                            max: 29,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }

            };

            let myChart = new Chart(
                document.getElementById(`myChartCanvas`),
                config
            );

            proximaAtualizacao = setTimeout(() => atualizarGrafico(id, dados, myChart), 5000);
        }

        function atualizarGrafico(id, dados, myChart) {
            fetch(`/medidas/tempo-real/${id}`, { cache: 'no-store' }).then(response => {
                if (response.ok) {
                    response.json().then(novoRegistro => {
                        const aviso = document.getElementById(`avisoCaptura${id}`);
                        aviso.innerHTML = "";

                        const novo = novoRegistro[0];
                        if (novo.momento_grafico === dados.labels[dados.labels.length - 1]) {
                            aviso.innerHTML = `<i class="fa-solid fa-triangle-exclamation"></i> Sem dados novos.`;
                        } else {
                            dados.labels.shift();
                            dados.labels.push(novo.momento_grafico);

                            dados.datasets[0].data.shift();
                            dados.datasets[0].data.push(novo.temperatura);

                            dados.datasets[1].data.shift();
                            dados.datasets[1].data.push(22);

                            dados.datasets[2].data.shift();
                            dados.datasets[2].data.push(18);

                            myChart.update();
                        }

                        proximaAtualizacao = setTimeout(() => atualizarGrafico(id, dados, myChart), 5000);
                    });
                }
            }).catch(error => {
                console.error("Erro na atualização:", error);
            });
        }

        document.getElementById("dataAtualizacao").innerText = new Date().toLocaleString();


        window.onload = () => {
            obterDadosGrafico(1);
        };

        function iniciarVerificacaoApos1Min30() {
            const chave = "tempoEntrada";
            const agora = Date.now();

            if (!localStorage.getItem(chave)) {
                localStorage.setItem(chave, agora);
            }

            const tempoSalvo = parseInt(localStorage.getItem(chave), 10);
            const tempoDecorrido = agora - tempoSalvo;
            const umMinMeio = 1.5 * 60 * 1000; // 1 minuto e meio em milissegundos
            console.log("Tempo necessário:", umMinMeio, "ms");

            if (tempoDecorrido >= umMinMeio) {
                console.log('Executando verificação imediatamente');
                buscarDadosEVerificar();
                iniciarRepeticao(); // inicia repetição após 1ª execução
            } else {
                console.log('Aguardando o tempo restante antes da primeira execução');
                const restante = umMinMeio - tempoDecorrido;
                setTimeout(function () {
                    buscarDadosEVerificar();
                    iniciarRepeticao(); // inicia repetição após o delay
                }, restante);
            }
        }

        // function iniciarRepeticao() {
        //     // Repete buscarDadosEVerificar a cada 1.5 minutos
        //     setInterval(buscarDadosEVerificar, 1.5 * 60 * 1000);
        // }

        function buscarDadosEVerificar() {
            console.log('Buscando dados e verificando...');
            const session = sessionStorage.FERMENTADORAS;

            const idEmpresa = JSON.parse(session)[0].fkEmpresa;

            fetch(`/medidas/validacaoTemp/${idEmpresa}`, { cache: 'no-store' })
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    } else {
                        throw new Error('Nenhum dado encontrado');
                    }
                })
                .then(resposta => {
                    verificarAlerta(resposta);
                })
                .catch(error => {
                    console.error('Erro na API:', error);
                });
        }

        function verificarAlerta(dados) {
            const sensores = {};

            for (let i = 0; i < dados.length; i++) {
                const dado = dados[i];
                const sensorId = dado.fkSensor;

                if (!sensores[sensorId]) {
                    sensores[sensorId] = [];
                }
                sensores[sensorId].push(dado);
            }

            console.log('Sensores agrupados:', sensores);

            const listaSensores = Object.keys(sensores);
            console.log('Lista de sensores:', listaSensores);

            for (let i = 0; i < listaSensores.length; i++) {
                const sensorId = listaSensores[i];
                const registros = sensores[sensorId];
                const total = registros.length;

                let criteriosAlerta = {
                    maxCritico,
                    minCritico,
                    maxAtencao,
                    minAtencao,
                    maxCuidado,
                    minCuidado
                }


                for (let j = 0; j < registros.length; j++) {
                    const registroCerveja = registros[j];
                    if (registroCerveja.temperatura < registroCerveja.limiteTempMin || registroCerveja.temperatura > registroCerveja.limiteTempMax) {
                        if (registroCerveja.temperatura <= registroCerveja.limiteTempMin - 5) {
                            criteriosAlerta.maxCritico += 1;
                        } else if (registroCerveja.temperatura >= registroCerveja.limiteTempMin + 5) {
                            criteriosAlerta.maxCritico += 1;
                        } else if (registroCerveja.temperatura <= registroCerveja.limiteTempMin - 3) {
                            criteriosAlerta.minAtencao += 1;
                        } else if (registroCerveja.temperatura >= registroCerveja.limiteTempMin + 3) {
                            criteriosAlerta.maxAtencao += 1;
                        } else if (registroCerveja.temperatura <= registroCerveja.limiteTempMin - 1) {
                            criteriosAlerta.minCuidado += 1;
                        } else if (registroCerveja.temperatura >= registroCerveja.limiteTempMin + 1) {
                            criteriosAlerta.maxCuidado += 1;
                        }
                    }
                }

                var totalForaDoIdeal = criteriosAlerta.minCuidado + criteriosAlerta.maxCuidado + criteriosAlerta.minAtencao + criteriosAlerta.maxAtencao + criteriosAlerta.minCritico + criteriosAlerta.maxCritico;

                const percentual = (totalForaDoIdeal / total) * 100;

                if (percentual >= 80) {
                    alert(`⚠️ Sensor ${sensorId}: ${percentual.toFixed(1)}% fora do ideal!`);
                } else {
                    console.log(`Sensor ${sensorId}: tudo certo (${percentual.toFixed(1)}% fora).`);
                }
            }
        }

        // Inicia o processo
        // iniciarVerificacaoApos1Min30();

        function cadastrarAlerta() {
            const session = sessionStorage.FERMENTADORAS;
            const idEmpresa = JSON.parse(session)[0].fkEmpresa;

            fetch(`/medidas/validacaoTemp/${idEmpresa}`, { cache: 'no-store' })
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    } else {
                        throw new Error('Nenhum dado encontrado');
                    }
                })
                .then(resposta => {
                    verificarAlerta(resposta);
                })
                .catch(error => {
                    console.error('Erro na API:', error);
                });
        }
    </script>
</body>

</html>