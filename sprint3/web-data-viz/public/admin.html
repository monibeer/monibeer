<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./css/assets/main.css">
    <link rel="stylesheet" href="./css/assetsDashboard/main.css">
    <link rel="stylesheet" href="./css/indexDashboard.css">
    <link rel="stylesheet" href="./css/admin.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
    <title>Admin</title>
</head>
<style>

</style>

<body>
    <section class="dashboard">
         <div class="sidebar">
            <a href="./index-dashboard.html">
                <div class="logotipo">
                    <img src="./assets/monibeer-logo.png" alt="">
                </div>
            </a>

            <!-- <div class="profile">
            <div class="circle-profile">
                <img src="./assets/image.png" alt="" class="profile-img">
            </div>
            <h3>Rodrigo Souza</h3>
            <p>Administrador</p>
        </div> -->

            <div class="buttons-navegation">
                <div class="container-item">
                    <a href="./index-dashboard.html">
                        <div class="navigation-item ">
                            <i class="fa-solid fa-house"></i>
                            <p>Home</p>
                        </div>
                    </a>

                    <a href="./setores.html">
                        <div class="navigation-item">
                            <i class="fa-solid fa-layer-group"></i>
                            <p>Meus Setores</p>
                        </div>
                    </a>
                    <a href="./admin.html">
                        <div class="navigation-item active">
                            <i class="fa-solid fa-building"></i>
                            <p>Funcionario</p>
                        </div>
                    </a>

                    <!-- Inserir link do jira -->
                    <a href="https://monibeer.atlassian.net/servicedesk/customer/portal/35">
                        <div class="navigation-item">
                            <i class="fa-solid fa-headset"></i>
                            <p>Suporte</p>
                        </div>
                    </a>

                    <!-- <div class="navigation-item">
                    <i class="fa-solid fa-gear"></i>
                    <p>Configurações</p>
                </div> -->
                </div>

                <a href="./login.html">
                    <div class="logout-item navigation-item">
                        <i class="fa-solid fa-right-from-bracket"></i>
                        <p>Logout</p>
                    </div>
                </a>
            </div>
        </div>

        <div class="container-dashboard">
            <div class="header">
                <div class="container-searchBarGroup">
                    <i class="fa-solid fa-bars"></i>

                    <h3>Funcionarios</h3>
                    <!-- <div class="container-search">
                    <i class="fa-solid fa-magnifying-glass"></i>
                    <input type="text" placeholder="Search..">
                </div> -->
                </div>
                <div class="container-actions">
                    <!-- <div class="container-theme-dark-light">
                    <img src="https://static-00.iconduck.com/assets.00/sun-symbol-emoji-512x512-qjm8vnpc.png" alt="">
                </div> -->
                    <span>|</span>
                    <div class="container-mini-profile">
                        <img src="https://media.istockphoto.com/id/1091291084/pt/vetorial/neutral-profile-picture.jpg?s=612x612&w=0&k=20&c=D5UkG2zMnMuM6XwHQjhY61tNIk_1kyiEu4XcgcI5lQs="
                            alt="">
                        <p id="header_usuario">Rodrigo Silva</p>
                    </div>
                </div>
            </div>


            <div class="container-dashboard">
                <div class="container-cadastro">
                    <strong id="texto-cadastro-funcionario">cadastro funcionario</strong>
                    <div id="modalFuncionario" style="display: none;">

                        <!--cadastro funcionario-->
                        <div id="modal-content">
                            <h3>Cadastrar Funcionário</h3>
                            <div class="atualizar-dados">
                                <strong>Nome:</strong>
                                <input type="text" id="inputNomeCadastro" placeholder="Nome">
                                <strong>Email:</strong>
                                <input type="email" id="inputEmailCadastro" placeholder="Email">
                                <strong>Senha:</strong>
                                <input type="password" id="inputSenhaCadastro" placeholder="Senha">
                                <strong>Tipo funcionario:</strong>
                                <select id="selectTipoCadastro">
                                    <option value="administrador">Administrador</option>
                                    <option value="funcionario">Funcionário</option>
                                </select>
                            </div>
                            <div class="button-cadastrar">
                                <button id="cancelar" onclick="fecharModalCadastro()">Cancelar</button>
                                <button id="salvar" onclick="cadastrarFuncionario()">Salvar</button>
                            </div>
                        </div>
                    </div>
                    <br>

                    <h1>Lista de Funcionários</h1>
                    <div class="row-buttons">
                        <button id="button-addfuncionario" onclick="abrirModalCadastro()">Adicionar funcionário</button>

                        <!-- <div class="input-icon">
                            <i class="fa-solid fa-magnifying-glass"></i>
                            <input id="input_nome_funcionario" type="text" placeholder="Buscar funcionário" />
                        </div> -->
                    </div>
                    <div id="usuarios">
                        <div class="registro">
                            <table border="1">
                                <thead>
                                    <tr>
                                        <th>Nome</th>
                                        <th>Email</th>
                                        <th>Tipo</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody id="tabelaFuncionarios">
    
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div id="modal">
                        <div id="modal-content">
                            <h3>Atualizar Funcionário</h3>
                            <div class="atualizar-dados">
                                <strong>Nome:</strong>
                                <input type="text" id="inputNome" placeholder="Nome">
                                <strong>Email:</strong>
                                <input type="email" id="inputEmail" placeholder="Email">
                                <strong>Senha:</strong>
                                <input type="password" id="inputSenha" placeholder="Senha">
                                <strong>Tipo funcionario:</strong>
                                <input type="text" id="inputTipo"
                                    placeholder="Tipo de Usuário (administrador/funcionario)">
                            </div>
                            <div class="button-atualizar">
                                <button id="cancelar" onclick="fecharModal()">Cancelar</button>
                                <button id="salvar" onclick="confirmarAtualizacao()">Salvar</button>
                            </div>

                        </div>
                    </div>
                </div>
    </section>
    </div>
    </div>


</body>

</html>
<script>
    header_usuario.innerHTML = sessionStorage.NOME_USUARIO;


    const idAdmin = sessionStorage.getItem("ID_USUARIO");
    const isAdmin = sessionStorage.getItem("TIPO_USUARIO");
    let funcionarioAtualId = null;

    if (isAdmin !== 'administrador') {
        alert("Você precisa estar logado como administrador.");
        window.location.href = "/index-dashboard.html";
    }

    fetch(`/usuarios/buscar/${idAdmin}`)
        .then(res => res.json())
        .then(admin => {
            const fkEmpresa = admin.fkEmpresa;

            fetch(`/usuarios/listar/${fkEmpresa}`)
                .then(res => res.json())
                .then(funcionarios => {
                    const tbody = document.getElementById("tabelaFuncionarios");
                    tbody.innerHTML = ""; 

                    funcionarios.forEach(user => {
                        const tr = document.createElement("tr");
                        tr.innerHTML = `
                            <td>${user.nome}</td>
                            <td>${user.email}</td>
                            <td>${user.tipoUsuario}</td>
                            <td class="td-buttons" style="justify-content: flex-end; gap: 15px;">
                                <button id="button-deletar" onclick="deletarUsuario(${user.idFuncionario})">Deletar</button>
                                <button id="button-atualizar"
                                    onclick="abrirModal(${user.idFuncionario}, '${user.nome}', '${user.email}', '${user.tipoUsuario}')">Atualizar</button>
                            </td>
            `;
            tbody.appendChild(tr);
                    });
                });
        });

    function abrirModal(id, nome, email, tipo) {
        funcionarioAtualId = id;
        document.getElementById("inputNome").value = nome;
        document.getElementById("inputEmail").value = email;
        document.getElementById("inputSenha").value = "";
        document.getElementById("inputTipo").value = tipo;

        document.getElementById("modal").style.display = "block";
    }

    function fecharModal() {
        document.getElementById("modal").style.display = "none";
        funcionarioAtualId = null;
    }

    function abrirModalCadastro() {
        document.getElementById("modalFuncionario").style.display = "block";
    }

    function fecharModalCadastro() {
        document.getElementById("modalFuncionario").style.display = "none";

        document.getElementById("inputNomeCadastro").value = "";
        document.getElementById("inputEmailCadastro").value = "";
        document.getElementById("inputSenhaCadastro").value = "";
        document.getElementById("selectTipoCadastro").value = "";
    }


    function confirmarAtualizacao() {
        const nome = document.getElementById("inputNome").value;
        const email = document.getElementById("inputEmail").value;
        const senha = document.getElementById("inputSenha").value;
        const tipo = document.getElementById("inputTipo").value;

        if (!nome || !email || !senha || !tipo) {
            return alert("Preencha todos os campos!");
        }

        fetch(`/usuarios/atualizar/${funcionarioAtualId}`, {
            method: "PUT",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                nomeServer: nome,
                emailServer: email,
                senhaServer: senha,
                tipoUsuarioServer: tipo
            })
        })
            .then(res => {
                if (res.ok) {
                    alert("Usuário atualizado com sucesso!");
                    fecharModal();
                    location.reload();
                } else {
                    alert("Erro ao atualizar.");
                }
            });
    }

    function deletarUsuario(id) {
        const confirmar = confirm("Tem certeza que deseja deletar este usuário?");

        if (!confirmar) return;

        fetch(`/usuarios/deletar/${id}`, { method: "DELETE" })
            .then(res => {
                if (res.ok) {

                    alert("Usuário deletado.");
                    location.reload();
                } else {
                    alert("Erro ao deletar usuário.");
                }
            });
    }

    function cadastrarFuncionario() {
        const nome = document.getElementById("inputNomeCadastro").value;
        const email = document.getElementById("inputEmailCadastro").value;
        const senha = document.getElementById("inputSenhaCadastro").value;
        const tipoUsuario = document.getElementById("selectTipoCadastro").value;

        if (!nome || !email || !senha || !tipoUsuario) {
            alert("Por favor, preencha todos os campos.");
            return;
        }

        const idAdmin = sessionStorage.getItem("ID_USUARIO");

        fetch(`/usuarios/buscar/${idAdmin}`)
            .then(res => res.json())
            .then(admin => {
                const empresaId = admin.fkEmpresa;

                fetch("/usuarios/cadastrar", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        nomeServer: nome,
                        emailServer: email,
                        senhaServer: senha,
                        empresaServer: empresaId,
                        tipoUsuarioServer: tipoUsuario
                    })
                })
                    .then(res => res.json())
                    .then(data => {
                        alert(data.mensagem || "Funcionário cadastrado com sucesso!");
                        fecharModalCadastro();
                        location.reload();
                    })
                    .catch(err => {
                        console.error("Erro ao cadastrar funcionário:", err);
                        alert("Erro ao cadastrar funcionário.");
                    });
            })
            .catch(err => {
                console.error("Erro ao buscar admin:", err);
                alert("Erro ao obter dados da empresa.");
            });
    }

</script>