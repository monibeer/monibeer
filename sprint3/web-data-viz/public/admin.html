<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
     <link rel="stylesheet" href="./css/assets/main.css">
    <link rel="stylesheet" href="./css/assetsDashboard/main.css">
    <link rel="stylesheet" href="./css/indexDashboard.css">
    <link rel="stylesheet" href="./css/admin.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
    <title>Admin</title>
</head>
<style>
    
</style>

<body>
    <section class="dashboard">
        <div class="sidebar">
            <a href="./index-dashboard.html">
                <div class="logotipo">
                    <img src="./assets/monibeer-logo.png" alt="Logo Monibeer" />
                </div>
            </a>

            <div class="buttons-navegation">
                <div class="container-item">
                    <a href="./index-dashboard.html">
                        <div class="navigation-item">
                            <i class="fa-solid fa-house"></i>
                            <p>Home</p>
                        </div>
                    </a>
                    <a href="./setores.html">
                        <div class="navigation-item">
                            <i class="fa-solid fa-building"></i>
                            <p>Meus Setores</p>
                        </div>
                    </a>
                     <a href="./admin.html">
                        <div class="navigation-item">
                            <i class="fa-solid fa-building"></i>
                            <p>funcionario</p>
                        </div>
                    </a>
                    <!-- Fe coloca o link para a tela de admin caso admin no session storage-->
                </div>

                <a href="./login.html">
                    <div class="logout-item navigation-item">
                        <i class="fa-solid fa-right-from-bracket"></i>
                        <p>Logout</p>
                    </div>
                </a>
            </div>
        </div>

        <div class="container-dashboard">
            <div class="header">
                <div class="container-searchBarGroup">
                    <i class="fa-solid fa-bars"></i>

                    <h3>Funcionarios</h3>
                    <!-- <div class="container-search">
                    <i class="fa-solid fa-magnifying-glass"></i>
                    <input type="text" placeholder="Search..">
                </div> -->
                </div>
                <div class="container-actions">
                    <!-- <div class="container-theme-dark-light">
                    <img src="https://static-00.iconduck.com/assets.00/sun-symbol-emoji-512x512-qjm8vnpc.png" alt="">
                </div> -->
                    <i class="fa-solid fa-bell"></i>
                    <span>|</span>
                    <div class="container-mini-profile">
                        <img src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png" alt="">
                        <p id="header_usuario">Rodrigo Silva</p>
                    </div>
                </div>
            </div>


        

        <div class="container-dashboard">
            <div class="container-cadastro">
            <strong id="texto-cadastro-funcionario">cadastro funcionario</strong>
            <h1>Lista de Funcionários</h1>
            <div class="row-buttons">
                <button id="button-adm" onclick="cadastrar()">Administrador</button>
                <button id="button-funcionario" onclick="listar()">Funcionarios</button>
                <div class="input-icon">
                    <i class="fa-solid fa-magnifying-glass"></i>
                    <input id="input_nome_funcionario" type="text" placeholder="Buscar funcionário" />
                </div>
            </div>

            
            <div id="usuarios"></div>
        
            <div id="modal">
                <div id="modal-content">
                    <h3>Atualizar Funcionário</h3>
                    <div class="atualizar-dados">
                        <strong>Nome:</strong>
                        <input type="text" id="inputNome" placeholder="Nome">
                        <strong>Email:</strong>
                        <input type="email" id="inputEmail" placeholder="Email">
                        <strong>Senha:</strong>
                        <input type="password" id="inputSenha" placeholder="Senha">
                        <strong>Tipo funcionario:</strong>
                        <input type="text" id="inputTipo" placeholder="Tipo de Usuário (administrador/funcionario)">
                    </div>
                    <div class="button-atualizar">
                        <button id="cancelar" onclick="fecharModal()">Cancelar</button>
                    <button id="salvar" onclick="confirmarAtualizacao()">Salvar</button>
                    </div>
                    
                </div>
            </div>
        </div>
    </section>
    </div>
</div>

   
</body>

</html>
<script>
    const idAdmin = sessionStorage.getItem("ID_USUARIO");
    const isAdmin = sessionStorage.getItem("TIPO_USUARIO");
    let funcionarioAtualId = null;

    if (isAdmin !== 'administrador') {
        alert("Você precisa estar logado como administrador.");
        window.location.href = "/index-dashboard.html";
    }

    fetch(`/usuarios/buscar/${idAdmin}`)
        .then(res => res.json())
        .then(admin => {
            const fkEmpresa = admin.fkEmpresa;

            fetch(`/usuarios/listar/${fkEmpresa}`)
                .then(res => res.json())
                .then(funcionarios => {
                    const container = document.getElementById("usuarios");

                    funcionarios.forEach(user => {
                        const div = document.createElement("div");
                        div.innerHTML = `

                        <div class="registro">
                        <table border="1">
                            <thead>
                                <tr>
                                <th>Nome</th>
                                <th>Email</th>
                                <th>Tipo</th>
                                <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                <td>${user.nome}</td>
                                <td> ${user.email}</td>
                                <td> ${user.tipoUsuario}</td>
                                <td class="td-buttons" style=" justify-content: flex-end; gap: 15px;"><button id="button-deletar" onclick="deletarUsuario(${user.idFuncionario})">Deletar</button>
                                    <button id="button-atualizar" onclick="abrirModal(${user.idFuncionario}, '${user.nome}', '${user.email}', '${user.tipoUsuario}')">Atualizar</button>
                                </td>
                                </tr>
                            </tbody>
                        </table>
                        </div>`;
                        container.appendChild(div);
                    });
                });
        });
    
    function abrirModal(id, nome, email, tipo) {
        funcionarioAtualId = id;
        document.getElementById("inputNome").value = nome;
        document.getElementById("inputEmail").value = email;
        document.getElementById("inputSenha").value = "";
        document.getElementById("inputTipo").value = tipo;

        document.getElementById("modal").style.display = "block";
    }

    function fecharModal() {
        document.getElementById("modal").style.display = "none";
        funcionarioAtualId = null;
    }

    function confirmarAtualizacao() {
        const nome = document.getElementById("inputNome").value;
        const email = document.getElementById("inputEmail").value;
        const senha = document.getElementById("inputSenha").value;
        const tipo = document.getElementById("inputTipo").value;

        if (!nome || !email || !senha || !tipo) {
            return alert("Preencha todos os campos!");
        }

        fetch(`/usuarios/atualizar/${funcionarioAtualId}`, {
            method: "PUT",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                nomeServer: nome,
                emailServer: email,
                senhaServer: senha,
                tipoUsuarioServer: tipo
            })
        })
            .then(res => {
                if (res.ok) {
                    alert("Usuário atualizado com sucesso!");
                    fecharModal();
                    location.reload();
                } else {
                    alert("Erro ao atualizar.");
                }
            });
    }

    function deletarUsuario(id) {
        const confirmar = confirm("Tem certeza que deseja deletar este usuário?");

        if(!confirmar) return;

        fetch(`/usuarios/deletar/${id}`, { method: "DELETE" })
            .then(res => {
                if (res.ok) {
                    
                    alert("Usuário deletado.");
                    location.reload();
                } else {
                    alert("Erro ao deletar usuário.");
                }
            });
    }
</script>